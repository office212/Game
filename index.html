<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Super Mario</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html, body { background:#000; width:100%; height:100%; overflow:hidden; touch-action:none; }
  body { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; font-family:'Press Start 2P', monospace; }

  #hud {
    width:100%; max-width:900px;
    background:#000;
    color:#fff;
    display:flex;
    justify-content:space-between;
    padding:6px 12px;
    font-size:10px;
    letter-spacing:1px;
    flex-shrink:0;
  }
  #hud span { display:flex; flex-direction:column; gap:2px; }
  #hud .label { color:#aaa; font-size:7px; }
  #hud .val { color:#fff; font-size:11px; }

  #canvasWrap {
    width:100%; max-width:900px;
    flex-shrink:0;
    position:relative;
  }
  canvas { display:block; width:100%; height:auto; border:none; }

  /* \u2500\u2500 TOUCH CONTROLS \u2500\u2500 */
  #controls {
    width:100%; max-width:900px;
    display:none;
    justify-content:space-between;
    align-items:center;
    padding:10px 16px;
    background:#111;
    flex-shrink:0;
    gap:10px;
  }
  .ctrl-group { display:flex; gap:8px; }
  .btn-ctrl {
    width:68px; height:68px;
    background:rgba(255,255,255,0.12);
    border:2px solid rgba(255,255,255,0.25);
    border-radius:50%;
    color:#fff;
    font-size:22px;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    user-select:none;
    -webkit-user-select:none;
    transition:background 0.08s;
    flex-shrink:0;
  }
  .btn-ctrl:active, .btn-ctrl.pressed {
    background:rgba(255,200,0,0.35);
    border-color:#f8c000;
    transform:scale(0.93);
  }
  #btnJump {
    width:80px; height:80px;
    background:rgba(229,34,34,0.5);
    border-color:#e52222;
    font-size:18px;
  }
  #btnRun {
    width:62px; height:62px;
    background:rgba(48,96,200,0.4);
    border-color:#3060c8;
    font-size:13px;
  }

  #overlay {
    position:fixed; top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.88);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    color:#fff; gap:20px; z-index:10;
    padding:20px;
  }
  #overlay h1 { font-size:clamp(18px,5vw,36px); color:#f8c000; text-shadow:4px 4px #c00; letter-spacing:4px; text-align:center; }
  #overlay p { font-size:clamp(8px,2vw,12px); color:#ccc; text-align:center; }
  .btn {
    margin-top:10px; padding:14px 32px; background:#e52222; border:none;
    color:#fff; font-family:inherit; font-size:clamp(10px,2.5vw,13px); cursor:pointer;
    border-bottom:4px solid #900; letter-spacing:2px;
    transition: transform 0.1s;
  }
  .btn:active { transform:scale(0.96); }
  .controls-hint { color:#888; font-size:clamp(7px,1.8vw,9px); text-align:center; line-height:2.2; }
</style>
</head>
<body>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<div id="hud">
  <span><span class="label">MARIO</span><span class="val" id="scoreEl">000000</span></span>
  <span style="align-items:center"><span class="label">COINS</span><span class="val" id="coinsEl">\u00d700</span></span>
  <span style="align-items:center"><span class="label">WORLD</span><span class="val">1-1</span></span>
  <span style="align-items:center"><span class="label">TIME</span><span class="val" id="timeEl">300</span></span>
  <span style="align-items:flex-end"><span class="label">LIVES</span><span class="val" id="livesEl">\u2665 3</span></span>
</div>

<div id="canvasWrap">
  <canvas id="game" width="900" height="500"></canvas>
</div>

<!-- Mobile D-pad + buttons -->
<div id="controls">
  <div class="ctrl-group">
    <div class="btn-ctrl" id="btnLeft">\u25c0</div>
    <div class="btn-ctrl" id="btnRight">\u25b6</div>
  </div>
  <div class="ctrl-group" style="align-items:center; gap:12px;">
    <div class="btn-ctrl" id="btnRun">RUN</div>
    <div class="btn-ctrl" id="btnJump">\u25b2<br><span style="font-size:9px">JUMP</span></div>
  </div>
</div>

<div id="overlay">
  <h1>SUPER MARIO</h1>
  <div class="controls-hint" id="ctrlHint">
    \u2190 \u2192 : \u05d4\u05d6\u05d6\u05d4 &nbsp;|&nbsp; SPACE / \u2191 : \u05e7\u05e4\u05d9\u05e6\u05d4<br>
    Z : \u05e8\u05d9\u05e6\u05d4 \u05de\u05d4\u05d9\u05e8\u05d4
  </div>
  <button class="btn" id="startBtn">\u25b6 START GAME</button>
</div>

<script>
// \u2500\u2500 DETECT MOBILE \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
const isMobile = /Android|iPhone|iPad|iPod|Touch/i.test(navigator.userAgent) || ('ontouchstart' in window);
if(isMobile){
  document.getElementById('controls').style.display = 'flex';
  document.getElementById('ctrlHint').innerHTML = '\u05d4\u05e9\u05ea\u05de\u05e9 \u05d1\u05db\u05e4\u05ea\u05d5\u05e8\u05d9\u05dd \u05dc\u05de\u05d8\u05d4 \u05dc\u05e9\u05d7\u05e7!';
}

// \u2500\u2500 AUDIO ENGINE \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
const AC = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq, dur, type='square', vol=0.15, decay=0.1){
  try {
    const o = AC.createOscillator(), g = AC.createGain();
    o.connect(g); g.connect(AC.destination);
    o.type = type; o.frequency.value = freq;
    g.gain.setValueAtTime(vol, AC.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, AC.currentTime + dur);
    o.start(); o.stop(AC.currentTime + dur + decay);
  } catch(e){}
}
function sfxJump(){ beep(400,0.05); setTimeout(()=>beep(600,0.08),50); }
function sfxCoin(){ beep(988,0.05); setTimeout(()=>beep(1318,0.12),60); }
function sfxStomp(){ beep(200,0.08,'sawtooth',0.2); beep(100,0.12,'sawtooth',0.2); }
function sfxDie(){ [400,350,300,250,200].forEach((f,i)=>setTimeout(()=>beep(f,0.1,'sawtooth',0.2),i*80)); }
function sfxPowerup(){ [523,659,784,1047].forEach((f,i)=>setTimeout(()=>beep(f,0.1,'sine',0.2),i*80)); }
function sfxBlockHit(){ beep(220,0.08,'sawtooth',0.25); }
function sfxWin(){ [523,659,784,880,988,1047].forEach((f,i)=>setTimeout(()=>beep(f,0.15,'sine',0.2),i*100)); }

// \u2500\u2500 CANVAS \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

// \u2500\u2500 PALETTE \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
const C = {
  sky:'#5c94fc', ground:'#e07030', groundTop:'#70b040',
  brick:'#c07030', brickDark:'#8b4513',
  qBlock:'#e8a000', qBlockShine:'#ffd060',
  coin:'#ffd700', coinShine:'#fff8a0',
  goomba:'#b06030', goombaFace:'#ffcc99', goombaDark:'#6b3a1f',
  flag:'#3c3', pipe:'#3c8c3c', pipeDark:'#1a6b1a', pipeLight:'#5cb85c',
};

const TILE = 40;
const WORLD_W = 7200;

let tiles=[], coins3D=[], mushrooms=[], enemies=[], particles=[];

function buildWorld(){
  tiles=[]; coins3D=[]; mushrooms=[]; enemies=[];

  for(let x=0; x<WORLD_W; x+=TILE){
    if(x>=3200 && x<3520) continue;
    if(x>=5600 && x<5760) continue;
    tiles.push({x, y:H-80, w:TILE, h:80, type:'ground'});
  }

  function addBrick(tx,ty){ tiles.push({x:tx*TILE,y:ty*TILE,w:TILE,h:TILE,type:'brick',hit:false}); }
  function addQ(tx,ty,contains='coin'){ tiles.push({x:tx*TILE,y:ty*TILE,w:TILE,h:TILE,type:'q',hit:false,contains}); }
  function addPipe(tx,ty,h=2){
    tiles.push({x:tx*TILE,y:ty*TILE,w:TILE*2,h:h*TILE,type:'pipe'});
    tiles.push({x:tx*TILE-4,y:ty*TILE-TILE/2,w:TILE*2+8,h:TILE/2,type:'pipeTop'});
  }

  addQ(7,6,'coin');
  addBrick(10,6); addQ(11,6,'mushroom'); addBrick(12,6); addBrick(13,6);
  addPipe(17,8,2); addPipe(22,7,3); addPipe(26,7,2);
  addBrick(32,6); addBrick(33,6); addBrick(34,6);
  addQ(35,5,'coin'); addBrick(36,6); addQ(37,6,'coin');
  for(let i=40;i<55;i++) addBrick(i,7);
  addQ(42,5,'coin'); addQ(45,5,'mushroom'); addQ(48,5,'coin');
  addPipe(57,8,3); addPipe(62,7,2);
  addBrick(68,7); addBrick(69,7); addBrick(70,7); addBrick(71,7);
  addQ(72,5,'coin'); addPipe(78,8,2);
  for(let i=85;i<95;i++) addBrick(i,7);
  addQ(88,5,'mushroom'); addQ(91,5,'coin');
  addPipe(100,8,3); addPipe(106,7,2);

  function goomba(tx){ enemies.push({x:tx*TILE,y:H-80-TILE,w:TILE,h:TILE,dx:-2,dy:0,alive:true,stomp:false,stompT:0}); }
  [12,19,30,38,50,60,70,85,100,120].forEach(goomba);

  for(let i=0;i<80;i+=6){
    coins3D.push({x:2000+i*30,y:H-160,r:8,collected:false});
  }

  tiles.filter(t=>t.type==='q'&&t.contains==='mushroom').forEach(t=>{
    mushrooms.push({x:t.x,y:t.y,w:TILE,h:TILE,dx:2,active:false,collected:false});
  });

  tiles.push({x:WORLD_W-160,y:H-80-280,w:8,h:280,type:'flagpole'});
}

// \u2500\u2500 PLAYER \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
let player = {x:60,y:200,w:36,h:44,dx:0,dy:0,grounded:false,big:false,invincible:0,dir:1,run:false,frame:0,frameT:0};
const SPEED=5, RUNSPEED=8, JUMP=16, GRAVITY=0.7;
let score=0, coins=0, lives=3, timeLeft=300;
let cameraX=0, timerInterval;
let gameStarted=false, gameOverState=false, winState=false;

// \u2500\u2500 INPUT \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
const keys = {};
document.addEventListener('keydown', e=>{ keys[e.code]=true; if(['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) e.preventDefault(); });
document.addEventListener('keyup', e=>{ keys[e.code]=false; });

// \u2500\u2500 TOUCH CONTROLS \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function bindTouchBtn(id, keyCode){
  const el = document.getElementById(id);
  if(!el) return;
  const press = e=>{ e.preventDefault(); keys[keyCode]=true; el.classList.add('pressed'); AC.resume(); };
  const release = e=>{ e.preventDefault(); keys[keyCode]=false; el.classList.remove('pressed'); };
  el.addEventListener('touchstart', press, {passive:false});
  el.addEventListener('touchend', release, {passive:false});
  el.addEventListener('touchcancel', release, {passive:false});
  // Also mouse for desktop testing
  el.addEventListener('mousedown', press);
  el.addEventListener('mouseup', release);
  el.addEventListener('mouseleave', release);
}
bindTouchBtn('btnLeft', 'ArrowLeft');
bindTouchBtn('btnRight', 'ArrowRight');
bindTouchBtn('btnJump', 'Space');
bindTouchBtn('btnRun', 'KeyZ');

// \u2500\u2500 COLLISION \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function rectOverlap(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }

// \u2500\u2500 PARTICLES \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function spawnBrick(tx,ty){ for(let i=0;i<6;i++) particles.push({x:tx+20,y:ty+20,vx:(Math.random()-0.5)*8,vy:-Math.random()*10-4,life:40,color:C.brick,size:8}); }
function spawnCoinPop(x,y){ particles.push({x,y,vx:0,vy:-12,life:30,color:C.coin,size:16}); }
function spawnPoints(x,y,pts){ particles.push({x,y,vx:0,vy:-1.5,life:50,text:'+'+pts,type:'text',color:'#fff'}); }

// \u2500\u2500 DRAW HELPERS \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function drawMario(x,y,big,dir,frame,invincible){
  if(invincible>0 && Math.floor(invincible/4)%2===1) return;
  ctx.save();
  ctx.translate(x+(dir<0?player.w:0),y);
  ctx.scale(dir,1);
  const s=big?1.6:1;

  ctx.fillStyle='#e03020'; ctx.fillRect(4*s,0,24*s,8*s); ctx.fillRect(0,8*s,30*s,4*s);
  ctx.fillStyle='#ffcc99'; ctx.fillRect(4*s,12*s,22*s,12*s);
  ctx.fillStyle='#000'; ctx.fillRect(20*s,14*s,4*s,4*s);
  ctx.fillStyle='#6b3010'; ctx.fillRect(6*s,20*s,18*s,4*s);
  ctx.fillStyle='#3060c8'; ctx.fillRect(2*s,24*s,28*s,16*s);
  ctx.fillStyle='#e03020'; ctx.fillRect(6*s,26*s,6*s,6*s); ctx.fillRect(20*s,26*s,6*s,6*s);
  ctx.fillStyle='#e03020'; ctx.fillRect(-4*s,24*s,8*s,14*s); ctx.fillRect(28*s,24*s,8*s,14*s);
  ctx.fillStyle='#ffcc99'; ctx.fillRect(-4*s,36*s,8*s,6*s); ctx.fillRect(28*s,36*s,8*s,6*s);
  ctx.fillStyle='#3060c8'; ctx.fillRect(2*s,40*s,12*s,8*s); ctx.fillRect(18*s,40*s,12*s,8*s);
  ctx.fillStyle='#3c1a00';
  const lf=frame%2===0?-2*s:0;
  ctx.fillRect(0+lf,48*s,14*s,6*s); ctx.fillRect(18*s-lf,48*s,14*s,6*s);
  ctx.restore();
}

function drawG