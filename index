<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>THE MONSTER ENGINE</title>
<style>
body{margin:0;overflow:hidden;background:black;}
canvas{display:block;margin:auto;}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>

const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
canvas.width=1800;
canvas.height=900;

let hue=0;
let shake=0;
let distortion=0;
let slow=1;
let meltdown=false;

let keys={};
document.addEventListener("keydown",e=>keys[e.code]=true);
document.addEventListener("keyup",e=>keys[e.code]=false);

let player={
x:400,y:400,w:40,h:40,
dx:0,dy:0,
hp:500
};

let enemies=[];
let bullets=[];
let particles=[];
let portals=[];
let blackHole={x:900,y:450,r:200};

for(let i=0;i<5;i++){
portals.push({
x:Math.random()*5000,
y:Math.random()*800
});
}

function spawnEnemy(){
let type=Math.floor(Math.random()*3);
enemies.push({
x:Math.random()*6000,
y:Math.random()*800,
dx:(Math.random()-0.5)*8,
dy:(Math.random()-0.5)*8,
hp:5,
type:type
});
}

setInterval(spawnEnemy,100);

function explode(x,y){
for(let i=0;i<300;i++){
particles.push({
x,y,
dx:(Math.random()-0.5)*40,
dy:(Math.random()-0.5)*40,
life:100
});
}
shake=60;
distortion=25;
}

function update(){

slow=enemies.length>300?0.3:1;

if(keys["ArrowRight"]) player.dx=12;
else if(keys["ArrowLeft"]) player.dx=-12;
else player.dx*=0.9;

if(keys["Space"]) player.dy=-20;

player.dy+=1;
player.x+=player.dx*slow;
player.y+=player.dy*slow;

if(player.y>canvas.height){
player.y=200;
player.hp-=30;
}

blackHole.x+=(player.x-blackHole.x)*0.01;
blackHole.y+=(player.y-blackHole.y)*0.01;

for(let p of portals){
if(Math.abs(player.x-p.x)<50 &&
Math.abs(player.y-p.y)<50){
let target=portals[Math.floor(Math.random()*portals.length)];
player.x=target.x;
player.y=target.y;
shake=40;
}
}

for(let e of enemies){

let dx=blackHole.x-e.x;
let dy=blackHole.y-e.y;
let d=Math.sqrt(dx*dx+dy*dy);

if(d<blackHole.r*3){
e.dx+=dx/d*1.2;
e.dy+=dy/d*1.2;
}

if(e.type===1){
e.dx+=(player.x-e.x)*0.0005;
e.dy+=(player.y-e.y)*0.0005;
}

if(e.type===2 && Math.random()<0.02){
bullets.push({
x:e.x,
y:e.y,
dx:(player.x-e.x)/20,
dy:(player.y-e.y)/20
});
}

e.x+=e.dx*slow;
e.y+=e.dy*slow;

if(d<blackHole.r){
explode(e.x,e.y);
e.hp=0;
}

if(Math.abs(player.x-e.x)<40 &&
Math.abs(player.y-e.y)<40){
player.hp-=1;
shake=15;
}
}

enemies=enemies.filter(e=>e.hp>0);

for(let b of bullets){
b.x+=b.dx;
b.y+=b.dy;
if(Math.abs(player.x-b.x)<20 &&
Math.abs(player.y-b.y)<20){
player.hp-=2;
shake=20;
}
}

for(let p of particles){
p.x+=p.dx*slow;
p.y+=p.dy*slow;
p.life--;
}
particles=particles.filter(p=>p.life>0);

if(player.hp<=0){
meltdown=true;
}

hue+=4;
if(distortion>0) distortion--;

}

function draw(){

ctx.save();

if(shake>0){
ctx.translate(Math.random()*shake-shake/2,
Math.random()*shake-shake/2);
shake--;
}

ctx.clearRect(0,0,canvas.width,canvas.height);

ctx.fillStyle="hsl("+hue+",100%,5%)";
ctx.fillRect(0,0,canvas.width,canvas.height);

ctx.fillStyle="hsl("+hue+",100%,50%)";
ctx.fillRect(player.x,player.y,player.w,player.h);

ctx.beginPath();
ctx.arc(blackHole.x,blackHole.y,blackHole.r,0,Math.PI*2);
ctx.fillStyle="black";
ctx.fill();
ctx.strokeStyle="hsl("+hue+",100%,50%)";
ctx.stroke();

ctx.fillStyle="orange";
for(let p of portals){
ctx.beginPath();
ctx.arc(p.x,p.y,30,0,Math.PI*2);
ctx.fill();
}

ctx.fillStyle="red";
for(let e of enemies){
ctx.fillRect(e.x,e.y,30,30);
}

ctx.fillStyle="cyan";
for(let b of bullets){
ctx.fillRect(b.x,b.y,8,8);
}

for(let p of particles){
ctx.fillStyle="hsl("+hue+",100%,60%)";
ctx.fillRect(p.x,p.y,5,5);
}

if(meltdown){
for(let i=0;i<100;i++){
ctx.fillStyle="rgba(255,0,0,0.05)";
ctx.fillRect(Math.random()*canvas.width,
Math.random()*canvas.height,
30,30);
}
ctx.filter="blur("+distortion+"px)";
}

ctx.restore();

ctx.fillStyle="white";
ctx.fillText("HP: "+player.hp,20,30);
ctx.fillText("Enemies: "+enemies.length,20,60);

}

function loop(){
update();
draw();
requestAnimationFrame(loop);
}

loop();

</script>
</body>
</html>
